<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Déblocage Leclerc</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <section class="card">
      <h1>Déblocage Leclerc</h1>
      <div class="status-panel" id="status-text">En attente…</div>
      <p class="muted">
        Cette page se met à jour automatiquement. Lorsqu'un blocage est détecté,
        vous serez redirigé vers l'URL à débloquer.
      </p>
      <p class="muted">
        Si aucune redirection ne se produit, vous pouvez ouvrir manuellement
        <a href="{{ fallback_url }}" target="_self">{{ fallback_url }}</a>.
      </p>
    </section>
  </main>

  <script>
    const statusText = document.getElementById('status-text');
    const fallbackUrl = {{ fallback_url | tojson }};

    function renderStatus(status) {
      if (status.blocked) {
        statusText.textContent = 'Blocage requis (captcha/accès bloqué).';
      } else {
        statusText.textContent = 'En attente de blocage…';
      }
    }

    async function pollStatus() {
      try {
        const resp = await fetch('/leclerc/unblock/status', { cache: 'no-store' });
        if (!resp.ok) {
          return;
        }
        const status = await resp.json();
        renderStatus(status);
        if (status.blocked && status.unblock_url) {
          if (status.unblock_url !== window.location.href) {
            window.location = status.unblock_url;
          }
        } else if (!status.blocked && window.location.href !== fallbackUrl) {
          // Keep user on kiosk when not blocked.
        }
      } catch (error) {
        // ignore transient errors
      }
    }

    renderStatus({ blocked: false });
    pollStatus();
    setInterval(pollStatus, 2000);
  </script>
</body>
</html>
