<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Déblocage Leclerc</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>Déblocage Leclerc</h1>

    <section class="card card-highlight">
      <h2>Action requise</h2>
      <p class="muted">
        Ouvrez la GUI HTTPS du navigateur Leclerc, résolvez le captcha/login, puis cliquez sur
        <strong>"J'ai débloqué"</strong> pour relancer automatiquement la collecte.
      </p>
      <div class="actions">
        <a id="unblock-link" class="button-link" target="_blank" rel="noopener">
          Ouvrir Leclerc
        </a>
        <button id="unblock-done" type="button">J'ai débloqué</button>
      </div>
      <div id="unblock-details" class="muted"></div>
      {% if blocked_url %}
      <p class="muted">
        Dernière URL bloquée: <a href="{{ blocked_url }}" target="_blank" rel="noopener">{{ blocked_url }}</a>
      </p>
      {% endif %}
      <div id="job-status" class="status-panel muted">Aucun blocage actif.</div>
    </section>
  </main>

  <script>
    const statusEl = document.getElementById('job-status');
    const unblockLink = document.getElementById('unblock-link');
    const unblockDone = document.getElementById('unblock-done');
    const unblockDetails = document.getElementById('unblock-details');
    const defaultGuiUrl = {{ leclerc_gui_url|tojson }};
    let currentJobId = null;

    function setStatus(text, badge) {
      statusEl.innerHTML = badge
        ? `<strong>${text}</strong> <span class="status-badge ${badge}">${badge.replace('status-', '').toUpperCase()}</span>`
        : text;
    }

    function renderUnblockDetails(reason, url) {
      const parts = [];
      if (reason) {
        parts.push(reason);
      }
      if (url) {
        parts.push(`URL: ${url}`);
      }
      unblockDetails.textContent = parts.join(' • ');
    }

    function renderUnblockError(message) {
      if (!message) {
        return;
      }
      unblockDetails.textContent = `Erreur: ${message}`;
    }

    async function pollUnblockState() {
      const resp = await fetch('/leclerc/unblock/status');
      if (!resp.ok) {
        return;
      }
      const data = await resp.json();
      if (data.unblock_url) {
        unblockLink.href = data.unblock_url;
      }
      if (data.blocked && data.job_id) {
        currentJobId = data.job_id;
        renderUnblockDetails(data.reason, data.blocked_url);
        setStatus(`Blocage actif pour le job #${data.job_id}`, 'status-blocked');
        return;
      }
      currentJobId = null;
      renderUnblockDetails('', '');
      setStatus('Aucun blocage actif.', null);
    }

    unblockLink.href = defaultGuiUrl;

    unblockDone.addEventListener('click', async () => {
      unblockDone.disabled = true;
      try {
        const doneResp = await fetch('/leclerc/unblock/done', {
          method: 'POST',
        });
        if (!doneResp.ok) {
          const errorPayload = await doneResp.json().catch(() => ({}));
          const message = errorPayload.detail || 'Impossible de valider le déblocage.';
          throw new Error(message);
        }
        await doneResp.json().catch(() => ({}));
      } catch (error) {
        renderUnblockError(error.message || 'Erreur inconnue.');
      } finally {
        unblockDone.disabled = false;
      }
    });

    pollUnblockState();
    setInterval(pollUnblockState, 3000);
  </script>
</body>
</html>
