<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drive Compare</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>Drive Compare</h1>

    <section class="card">
      <h2>Recherche produit</h2>
      <form id="search-form">
        <label>
          Rechercher un produit
          <input id="search" type="text" placeholder="Rechercher un produit" />
        </label>
        <button type="submit">Lancer la recherche Leclerc</button>
      </form>
      <div id="leclerc-unblock" class="hint card-highlight" hidden>
        <div><strong>Action requise: captcha Leclerc</strong></div>
        <div class="muted">
          Ouvrez le navigateur distant pour passer le captcha/login, puis revenez relancer la recherche.
        </div>
        <div class="actions">
          <a id="leclerc-unblock-link" class="button-link" target="_blank" rel="noopener">
            Ouvrir Leclerc (déblocage)
          </a>
          <button type="button" id="leclerc-unblock-done">J'ai terminé</button>
        </div>
      </div>
      <div id="job-status" class="muted"></div>
      <div id="job-results"></div>
      <h3>Résultats locaux</h3>
      <div id="results"></div>
    </section>

    <section class="card">
      <h2>Créer un panier rapide</h2>
      <form method="post" action="/baskets/form">
        <label>
          Nom du panier
          <input type="text" name="name" value="Panier" />
        </label>
        <label>
          Produit ID
          <input type="number" name="product_id" required />
        </label>
        <label>
          Quantité
          <input type="number" name="quantity" value="1" min="1" />
        </label>
        <button type="submit">Créer</button>
      </form>
      <p class="hint">Astuce: utilisez la recherche pour obtenir l'ID produit.</p>
    </section>

    <section class="card">
      <h2>Historique paniers</h2>
      <ul>
        {% for basket in baskets %}
          <li>
            <a href="/baskets/{{ basket.id }}">{{ basket.name }}</a>
            <span class="muted">({{ basket.item_count }} items, {{ basket.created_at }})</span>
          </li>
        {% else %}
          <li>Aucun panier pour le moment.</li>
        {% endfor %}
      </ul>
    </section>
  </main>
  <div id="mobile-actions" class="mobile-actions" hidden>
    <a id="mobile-unblock" class="button-link" target="_blank" rel="noopener">
      Débloquer Leclerc
    </a>
    <button type="button" id="mobile-retry">Relancer</button>
  </div>

  <script>
    const searchForm = document.getElementById('search-form');
    const search = document.getElementById('search');
    const results = document.getElementById('results');
    const jobStatus = document.getElementById('job-status');
    const jobResults = document.getElementById('job-results');
    const host = window.location.hostname;
    const leclercGuiUrl = `http://${host}:5801/`;
    const leclercUnblock = document.getElementById('leclerc-unblock');
    const leclercUnblockLink = document.getElementById('leclerc-unblock-link');
    const leclercUnblockDone = document.getElementById('leclerc-unblock-done');
    const mobileActions = document.getElementById('mobile-actions');
    const mobileUnblock = document.getElementById('mobile-unblock');
    const mobileRetry = document.getElementById('mobile-retry');
    let timeout;
    let poller;
    let currentJobId;

    async function setLeclercGuiActive(active) {
      await fetch('/leclerc/gui/active', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ active }),
      });
    }

    function notifyLeclercGuiActive(active) {
      const payload = JSON.stringify({ active });
      if (navigator.sendBeacon) {
        const blob = new Blob([payload], { type: 'application/json' });
        navigator.sendBeacon('/leclerc/gui/active', blob);
        return;
      }
      fetch('/leclerc/gui/active', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload,
        keepalive: true,
      });
    }

    leclercUnblockLink.href = leclercGuiUrl;
    mobileUnblock.href = leclercGuiUrl;

    [leclercUnblockLink, mobileUnblock].forEach((link) => {
      link.addEventListener('click', () => notifyLeclercGuiActive(true));
    });
    async function retryJob(jobId) {
      const resp = await fetch(`/jobs/${jobId}/retry`, { method: 'POST' });
      if (!resp.ok) {
        throw new Error('Retry failed');
      }
      const data = await resp.json();
      return data.job_id;
    }

    async function handleLeclercDone() {
      if (!currentJobId) {
        return;
      }
      if (poller) {
        clearInterval(poller);
      }
      leclercUnblockDone.disabled = true;
      mobileRetry.disabled = true;
      try {
        await fetch('/leclerc/unblock/done', { method: 'POST' });
        const newJobId = await retryJob(currentJobId);
        currentJobId = newJobId;
        jobStatus.innerHTML = `
          <strong>Job #${newJobId}</strong>
          <span class="status-badge status-pending">PENDING</span>
        `;
        poller = setInterval(async () => {
          const done = await pollJob(newJobId);
          if (done) {
            clearInterval(poller);
          }
        }, 1000);
      } catch (error) {
        jobStatus.textContent = "Impossible de relancer la recherche.";
      } finally {
        leclercUnblockDone.disabled = false;
        mobileRetry.disabled = false;
      }
    }

    leclercUnblockDone.addEventListener('click', handleLeclercDone);
    mobileRetry.addEventListener('click', handleLeclercDone);

    search.addEventListener('input', () => {
      clearTimeout(timeout);
      const query = search.value.trim();
      if (!query) {
        results.innerHTML = '';
        return;
      }
      timeout = setTimeout(async () => {
        const resp = await fetch(`/products/search?q=${encodeURIComponent(query)}`);
        const data = await resp.json();
        const localItems = data.map(item => {
          return `
            <div class="result-card">
              <strong>#${item.id} - ${item.name}</strong>
              <div class="muted">${item.brand || 'N/A'} ${item.size || ''} ${item.unit || ''}</div>
            </div>
          `;
        }).join('');
        results.innerHTML = localItems
          ? `<div class="results-grid">${localItems}</div>`
          : '<div class="muted">Aucun résultat</div>';
      }, 250);
    });

    function getBadgeInfo(job) {
      if (job.status === 'BLOCKED' || job.result?.reason === 'DATADOME_BLOCKED') {
        return { label: 'BLOCKED', className: 'status-blocked' };
      }
      const label = job.status === 'DONE' ? 'SUCCESS' : job.status;
      return { label, className: `status-${label.toLowerCase()}` };
    }

    function renderJob(job) {
      currentJobId = job.id;
      const badge = getBadgeInfo(job);
      jobStatus.innerHTML = `
        <strong>Job #${job.id}</strong>
        <span class="status-badge ${badge.className}">${badge.label}</span>
      `;
      if (job.status === 'DONE') {
        leclercUnblock.hidden = true;
        mobileActions.hidden = true;
        const items = (job.result?.items || []).map(item => {
          const price = item.price != null ? `${item.price} €` : 'N/A';
          const unitPrice = item.unit_price != null ? `${item.unit_price} ${item.unit || ''}` : '';
          return `
            <div class="result-card">
              <strong>${item.title || 'Produit'}</strong>
              <div class="muted">${item.brand || 'Marque inconnue'}</div>
              <div class="muted">${price} ${unitPrice}</div>
              <div class="muted">${item.url || ''}</div>
            </div>
          `;
        }).join('');
        jobResults.innerHTML = items
          ? `<div class="results-grid">${items}</div>`
          : '<div class="muted">Aucun résultat côté Leclerc.</div>';
      } else if (job.status === 'FAILED' || job.status === 'BLOCKED') {
        const debug = job.result?.debug || {};
        const reason = job.result?.reason || job.error || '';
        const details = [
          debug.network_log ? `Network: ${debug.network_log}` : null,
          debug.blocked_url ? `URL: ${debug.blocked_url}` : null,
          debug.blocked_png ? `Screenshot: ${debug.blocked_png}` : null,
          debug.blocked_html ? `HTML: ${debug.blocked_html}` : null,
          debug.error_png ? `Screenshot: ${debug.error_png}` : null,
          debug.error_html ? `HTML: ${debug.error_html}` : null,
        ].filter(Boolean).map(line => `<div>${line}</div>`).join('');
        if (job.status === 'BLOCKED' || reason === 'DATADOME_BLOCKED') {
          const instruction = debug.instruction || '';
          leclercUnblock.hidden = false;
          mobileActions.hidden = false;
          jobResults.innerHTML = `
            <div class="muted">
              Leclerc a bloqué l'accès automatique (DataDome). Ouvrez le navigateur distant pour débloquer (captcha/login).
            </div>
            ${instruction ? `<div class="muted">${instruction}</div>` : ''}
            ${details ? `<div class="muted">${details}</div>` : ''}
          `;
        } else if (reason === 'GUI_ACTIVE') {
          leclercUnblock.hidden = false;
          mobileActions.hidden = false;
          jobResults.innerHTML = `
            <div class="muted">
              Le navigateur distant est actif. Terminez la session puis cliquez "J'ai terminé".
            </div>
            ${details ? `<div class="muted">${details}</div>` : ''}
          `;
        } else {
          leclercUnblock.hidden = true;
          mobileActions.hidden = true;
          jobResults.innerHTML = `
            <div class="muted">La recherche a échoué: ${job.error || 'Erreur inconnue'}.</div>
            ${details ? `<div class="muted">${details}</div>` : ''}
          `;
        }
      } else {
        leclercUnblock.hidden = true;
        mobileActions.hidden = true;
        jobResults.innerHTML = '<div class="muted">Recherche en cours...</div>';
      }
    }

    async function pollJob(jobId) {
      const resp = await fetch(`/jobs/${jobId}`);
      if (!resp.ok) {
        jobStatus.textContent = 'Impossible de récupérer le job.';
        return true;
      }
      const job = await resp.json();
      renderJob(job);
      return job.status === 'DONE' || job.status === 'FAILED' || job.status === 'BLOCKED';
    }

    searchForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const query = search.value.trim();
      if (!query) {
        jobStatus.textContent = 'Veuillez saisir une recherche.';
        return;
      }
      jobStatus.textContent = 'Création du job...';
      jobResults.innerHTML = '';
      if (poller) {
        clearInterval(poller);
      }
      const resp = await fetch('/jobs/retailer-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });
      if (!resp.ok) {
        jobStatus.textContent = 'Impossible de lancer la recherche.';
        return;
      }
      const data = await resp.json();
      const initialBadge = getBadgeInfo({ status: data.status });
      jobStatus.innerHTML = `
        <strong>Job #${data.job_id}</strong>
        <span class="status-badge ${initialBadge.className}">${initialBadge.label}</span>
      `;
      currentJobId = data.job_id;
      poller = setInterval(async () => {
        const done = await pollJob(data.job_id);
        if (done) {
          clearInterval(poller);
        }
      }, 1000);
    });
  </script>
</body>
</html>
