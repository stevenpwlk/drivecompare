<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Drive Compare</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>Drive Compare</h1>

    <section class="card">
      <h2>Recherche produit</h2>
      <form id="search-form">
        <label>
          Rechercher un produit
          <input id="search" type="text" placeholder="Rechercher un produit" />
        </label>
        <button type="submit">Lancer la recherche Leclerc</button>
      </form>
      <div class="hint">
        <div><strong>Session Leclerc (mobile)</strong></div>
        <div>
          1) <a href="{{ leclerc_gui_url }}" target="_blank" rel="noopener">Ouvrir Leclerc (session)</a>
          2) Se connecter / passer le blocage 3) Revenir ici et relancer la recherche
        </div>
      </div>
      <div id="job-status" class="muted"></div>
      <div id="job-results"></div>
      <h3>Résultats locaux</h3>
      <div id="results"></div>
    </section>

    <section class="card">
      <h2>Créer un panier rapide</h2>
      <form method="post" action="/baskets/form">
        <label>
          Nom du panier
          <input type="text" name="name" value="Panier" />
        </label>
        <label>
          Produit ID
          <input type="number" name="product_id" required />
        </label>
        <label>
          Quantité
          <input type="number" name="quantity" value="1" min="1" />
        </label>
        <button type="submit">Créer</button>
      </form>
      <p class="hint">Astuce: utilisez la recherche pour obtenir l'ID produit.</p>
    </section>

    <section class="card">
      <h2>Historique paniers</h2>
      <ul>
        {% for basket in baskets %}
          <li>
            <a href="/baskets/{{ basket.id }}">{{ basket.name }}</a>
            <span class="muted">({{ basket.item_count }} items, {{ basket.created_at }})</span>
          </li>
        {% else %}
          <li>Aucun panier pour le moment.</li>
        {% endfor %}
      </ul>
    </section>
  </main>

  <script>
    const searchForm = document.getElementById('search-form');
    const search = document.getElementById('search');
    const results = document.getElementById('results');
    const jobStatus = document.getElementById('job-status');
    const jobResults = document.getElementById('job-results');
    const leclercGuiUrl = "{{ leclerc_gui_url }}";
    let timeout;
    let poller;

    search.addEventListener('input', () => {
      clearTimeout(timeout);
      const query = search.value.trim();
      if (!query) {
        results.innerHTML = '';
        return;
      }
      timeout = setTimeout(async () => {
        const resp = await fetch(`/products/search?q=${encodeURIComponent(query)}`);
        const data = await resp.json();
        results.innerHTML = data.map(item => {
          return `<div class="result">#${item.id} - ${item.name} (${item.brand || 'N/A'}) ${item.size || ''} ${item.unit || ''}</div>`;
        }).join('') || '<div class="muted">Aucun résultat</div>';
      }, 250);
    });

    function renderJob(job) {
      jobStatus.innerHTML = `<strong>Job #${job.id}</strong> - ${job.status}`;
      if (job.status === 'DONE') {
        const items = (job.result?.items || []).map(item => {
          const price = item.price != null ? `${item.price} €` : 'N/A';
          const unitPrice = item.unit_price != null ? `${item.unit_price} ${item.unit || ''}` : '';
          return `
            <div class="result">
              <strong>${item.title || 'Produit'}</strong>
              <div class="muted">${item.brand || 'Marque inconnue'} - ${price} ${unitPrice}</div>
              <div class="muted">${item.url || ''}</div>
            </div>
          `;
        }).join('');
        jobResults.innerHTML = items || '<div class="muted">Aucun résultat côté Leclerc.</div>';
      } else if (job.status === 'FAILED') {
        const debug = job.result?.debug || {};
        const reason = job.result?.reason || job.error || '';
        const details = [
          debug.network_log ? `Network: ${debug.network_log}` : null,
          debug.blocked_png ? `Screenshot: ${debug.blocked_png}` : null,
          debug.blocked_html ? `HTML: ${debug.blocked_html}` : null,
          debug.error_png ? `Screenshot: ${debug.error_png}` : null,
          debug.error_html ? `HTML: ${debug.error_html}` : null,
        ].filter(Boolean).map(line => `<div>${line}</div>`).join('');
        if (reason === 'DATADOME_BLOCKED') {
          const instruction = debug.instruction || '';
          jobResults.innerHTML = `
            <div class="muted">
              Leclerc a bloqué l'accès automatique (DataDome).
              <a href="${leclercGuiUrl}" target="_blank" rel="noopener">Ouvrir Leclerc (session)</a>
              puis relancer la recherche.
            </div>
            ${instruction ? `<div class="muted">${instruction}</div>` : ''}
            ${details ? `<div class="muted">${details}</div>` : ''}
          `;
        } else {
          jobResults.innerHTML = `
            <div class="muted">La recherche a échoué: ${job.error || 'Erreur inconnue'}.</div>
            ${details ? `<div class="muted">${details}</div>` : ''}
          `;
        }
      } else {
        jobResults.innerHTML = '<div class="muted">Recherche en cours...</div>';
      }
    }

    async function pollJob(jobId) {
      const resp = await fetch(`/jobs/${jobId}`);
      if (!resp.ok) {
        jobStatus.textContent = 'Impossible de récupérer le job.';
        return true;
      }
      const job = await resp.json();
      renderJob(job);
      return job.status === 'DONE' || job.status === 'FAILED';
    }

    searchForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const query = search.value.trim();
      if (!query) {
        jobStatus.textContent = 'Veuillez saisir une recherche.';
        return;
      }
      jobStatus.textContent = 'Création du job...';
      jobResults.innerHTML = '';
      if (poller) {
        clearInterval(poller);
      }
      const resp = await fetch('/jobs/retailer-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });
      if (!resp.ok) {
        jobStatus.textContent = 'Impossible de lancer la recherche.';
        return;
      }
      const data = await resp.json();
      jobStatus.innerHTML = `<strong>Job #${data.job_id}</strong> - ${data.status}`;
      poller = setInterval(async () => {
        const done = await pollJob(data.job_id);
        if (done) {
          clearInterval(poller);
        }
      }, 1000);
    });
  </script>
</body>
</html>
