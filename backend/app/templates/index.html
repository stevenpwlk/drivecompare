<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DriveCompare</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>DriveCompare</h1>

    <section class="card">
      <h2>Recherche Leclerc</h2>
      <form id="search-form">
        <label>
          Recherche
          <input id="search-input" type="text" placeholder="ex: coca" required />
        </label>
        <button type="submit">Lancer recherche Leclerc</button>
      </form>
      <div id="job-status" class="status-panel muted">Aucun job en cours.</div>
    </section>

    <section id="unblock-panel" class="card card-highlight" hidden>
      <h2>Blocage Leclerc: action requise</h2>
      <p class="muted">
        Leclerc a bloqué l'accès automatique. Ouvrez la GUI HTTPS pour résoudre le captcha/login,
        puis cliquez sur "J'ai débloqué" pour reprendre le job.
      </p>
      <div class="actions">
        <a id="unblock-link" class="button-link" target="_blank" rel="noopener">
          Ouvrir Leclerc
        </a>
        <button id="unblock-done" type="button">J'ai débloqué</button>
      </div>
      <div id="unblock-details" class="muted"></div>
    </section>

    <section class="card">
      <h2>Résultats</h2>
      <div id="results" class="results-grid"></div>
    </section>
  </main>

  <script>
    const form = document.getElementById('search-form');
    const input = document.getElementById('search-input');
    const statusEl = document.getElementById('job-status');
    const resultsEl = document.getElementById('results');
    const unblockPanel = document.getElementById('unblock-panel');
    const unblockLink = document.getElementById('unblock-link');
    const unblockDone = document.getElementById('unblock-done');
    const unblockDetails = document.getElementById('unblock-details');
    const defaultGuiUrl = {{ leclerc_gui_url|tojson }};

    let currentJobId = null;
    let pollTimer = null;
    let unblockTimer = null;
    let unblockActive = false;

    function setStatus(text, badge) {
      statusEl.innerHTML = badge
        ? `<strong>${text}</strong> <span class="status-badge ${badge}">${badge.replace('status-', '').toUpperCase()}</span>`
        : text;
    }

    function renderResults(items) {
      if (!items || items.length === 0) {
        resultsEl.innerHTML = '<div class="muted">Aucun résultat pour le moment.</div>';
        return;
      }
      resultsEl.innerHTML = items.map(item => {
        return `
          <div class="result-card">
            <strong>${item.title || 'Produit'}</strong>
            <div class="muted">${item.price != null ? `${item.price} €` : 'Prix indisponible'}</div>
            ${item.store ? `<div class="muted">${item.store}</div>` : ''}
            ${item.url ? `<a href="${item.url}" target="_blank" rel="noopener">Voir</a>` : ''}
          </div>
        `;
      }).join('');
    }

    async function fetchJob(jobId) {
      const resp = await fetch(`/jobs/${jobId}`);
      if (!resp.ok) {
        setStatus('Erreur récupération job.', 'status-failed');
        return null;
      }
      return await resp.json();
    }

    async function pollJob() {
      if (!currentJobId) {
        return;
      }
      const job = await fetchJob(currentJobId);
      if (!job) {
        return;
      }
      if (job.status === 'QUEUED' || job.status === 'RUNNING') {
        setStatus(`Job #${job.id}`, `status-${job.status.toLowerCase()}`);
        renderResults(job.result?.items || []);
        if (!unblockActive) {
          unblockPanel.hidden = true;
        }
        return;
      }
      if (job.status === 'BLOCKED') {
        setStatus(`Job #${job.id}`, 'status-blocked');
        renderResults(job.result?.items || []);
        unblockPanel.hidden = false;
        renderUnblockDetails(job.error || job.result?.reason, job.result?.blocked_url);
        return;
      }
      if (job.status === 'SUCCESS') {
        setStatus(`Job #${job.id}`, 'status-success');
        renderResults(job.result?.items || []);
        unblockPanel.hidden = true;
        clearInterval(pollTimer);
        return;
      }
      if (job.status === 'FAILED') {
        setStatus(`Job #${job.id}`, 'status-failed');
        renderResults(job.result?.items || []);
        unblockPanel.hidden = true;
        renderUnblockDetails(job.error || 'Erreur inconnue', null);
        clearInterval(pollTimer);
      }
    }

    function renderUnblockDetails(reason, url) {
      const parts = [];
      if (reason) {
        parts.push(reason);
      }
      if (url) {
        parts.push(`URL: ${url}`);
      }
      unblockDetails.textContent = parts.join(' • ');
    }

    function renderUnblockError(message) {
      if (!message) {
        return;
      }
      unblockDetails.textContent = `Erreur: ${message}`;
      unblockPanel.hidden = false;
    }

    async function pollUnblockState() {
      const resp = await fetch('/leclerc/unblock/status');
      if (!resp.ok) {
        return;
      }
      const data = await resp.json();
      if (data.unblock_url) {
        unblockLink.href = data.unblock_url;
      }
      if (data.blocked && data.job_id) {
        currentJobId = data.job_id;
        unblockActive = true;
        unblockPanel.hidden = false;
        renderUnblockDetails(data.reason, data.blocked_url);
        return;
      }
      unblockActive = false;
      unblockPanel.hidden = true;
    }

    unblockLink.href = defaultGuiUrl;

    unblockDone.addEventListener('click', async () => {
      unblockDone.disabled = true;
      try {
        const doneResp = await fetch('/leclerc/unblock/done', {
          method: 'POST',
        });
        if (!doneResp.ok) {
          const errorPayload = await doneResp.json().catch(() => ({}));
          const message = errorPayload.detail || 'Impossible de valider le déblocage.';
          throw new Error(message);
        }
        await doneResp.json().catch(() => ({}));
      } catch (error) {
        renderUnblockError(error.message || 'Erreur inconnue.');
      } finally {
        unblockDone.disabled = false;
      }
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const query = input.value.trim();
      if (!query) {
        setStatus('Veuillez saisir une recherche.');
        return;
      }
      resultsEl.innerHTML = '';
      unblockPanel.hidden = true;
      const resp = await fetch('/jobs/leclerc-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });
      if (!resp.ok) {
        setStatus('Impossible de lancer le job.', 'status-failed');
        return;
      }
      const data = await resp.json();
      currentJobId = data.job_id;
      setStatus(`Job #${currentJobId}`, 'status-queued');
      if (pollTimer) {
        clearInterval(pollTimer);
      }
      pollTimer = setInterval(pollJob, 1500);
    });

    pollUnblockState();
    if (unblockTimer) {
      clearInterval(unblockTimer);
    }
    unblockTimer = setInterval(pollUnblockState, 3000);
  </script>
</body>
</html>
